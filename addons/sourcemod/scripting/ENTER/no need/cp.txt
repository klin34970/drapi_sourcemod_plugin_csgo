/*<DR.API TIMER CHECKPOINTS> (c) by <De Battista Clint - (http://doyou.watch)*/
/*                                                                           */
/*             <DR.API TIMER CHECKPOINTS> is licensed under a                */
/*                        GNU General Public License                         */
/*																			 */
/*      You should have received a copy of the license along with this       */
/*            work.  If not, see <http://www.gnu.org/licenses/>.             */
//***************************************************************************//
//***************************************************************************//
//*************************DR.API TIMER CHECKPOINTS**************************//
//***************************************************************************//
//***************************************************************************//

#pragma semicolon 1 

//***********************************//
//*************DEFINE****************//
//***********************************//
#define PLUGIN_VERSION 					"1.0.0"
#define CVARS 							FCVAR_PLUGIN|FCVAR_SPONLY|FCVAR_NOTIFY
#define DEFAULT_FLAGS 					FCVAR_PLUGIN|FCVAR_NOTIFY
#define TAG_CHAT						"[TIMER CHECKPOINTS] -"
#define MAX_LEVEL 						100
#define MAX_BONUS 						5
#define MAX_STYLE						20

//***********************************//
//*************INCLUDE***************//
//***********************************//
#include <sourcemod>
#include <clientprefs>


#include <autoexec>
#include <botmimic>

#include <timer>
#include <timer-mysql>
#include <timer-stocks>
#include <timer-mapzones>
#include <timer-config_loader>

#pragma newdecls required

//***********************************//
//***********PARAMETERS**************//
//***********************************//

//Handle
Handle cvar_active_timer_checkpoint_dev;

Handle g_hSQL 										= INVALID_HANDLE;
Handle CookieTimerCPChat;

//Bool
bool B_active_timer_checkpoint_dev					= false;

bool B_active_hud_backstage[MAXPLAYERS+1]			= false;
bool B_active_hud[MAXPLAYERS+1]						= false;

//Strings
char S_mapname[32];
char sql_SelectPlayerCP[]							= "SELECT * FROM timercheckpoints WHERE steamid = ? AND level = ? AND map = ? AND track = ? AND style = ?";
char sql_insertPlayerCP[] 							= "INSERT INTO timercheckpoints (steamid, map, level, levelname, time, name, track, style) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
char sql_updatePlayerCP[] 							= "UPDATE timercheckpoints SET time = ?, name = ? WHERE steamid = ? AND map = ? AND level = ? AND track = ? AND style = ?";

char sql_SelectPlayerCPWR[]							= "SELECT * FROM timercheckpoints_wr WHERE map = ? AND level = ? AND track = ? AND style = ?";
char sql_insertPlayerCPWR[] 						= "INSERT INTO timercheckpoints_wr (steamid, map, level, levelname, time, name, track, style) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
char sql_updatePlayerCPWR[] 						= "UPDATE timercheckpoints_wr SET time = ?, name = ?, steamid = ? WHERE map = ? AND level = ? AND track = ? AND style = ?";

char sql_selectWRMap[] 								= "SELECT a.auth, a.name, a.map, a.track, a.style, b.time, b.steamid, b.level, b.map, b.track, b.style FROM round a JOIN timercheckpoints_wr b ON a.map = b.map AND a.track = b.track AND a.style = b.style WHERE a.rank = 1 AND RIGHT(a.auth, 7) = RIGHT(b.steamid, 7) AND b.level = ? AND b.map = ? AND b.track = ? AND b.style = ?";

char S_infopanel[MAXPLAYERS+1][MAX_STYLE][64];
char S_infopanelbonus[MAXPLAYERS+1][MAX_STYLE][MAX_BONUS][64];

//Float 
float F_infopanel[MAXPLAYERS+1][MAX_STYLE][MAX_LEVEL][3];
float F_infopanelbonus[MAXPLAYERS+1][MAX_STYLE][MAX_BONUS][MAX_LEVEL];
float F_infopanelbonus2[MAXPLAYERS+1][MAX_STYLE][MAX_BONUS][MAX_LEVEL];
float F_infopanelbonus3[MAXPLAYERS+1][MAX_STYLE][MAX_BONUS][MAX_LEVEL];

float F_Timer[MAXPLAYERS + 1];

//Informations plugin
public Plugin myinfo =
{
	name = "[TIMER] DR.API TIMER CHECKPOINTS",
	author = "Dr. Api",
	description = "DR.API TIMER CHECKPOINTS by Dr. Api",
	version = PLUGIN_VERSION,
	url = "http://zombie4ever.eu"
}

/***********************************************************/
/********************* ASK PLUGIN LOAD *********************/
/***********************************************************/
public APLRes AskPluginLoad2(Handle myself, bool late, char[] error, int err_max)
{
	RegPluginLibrary("timer-checkppoints");
	CreateNative("Timer_GetCheckpointsWR", Native_GetCheckpointsWR);
	CreateNative("Timer_GetCheckpointsWRBonus", Native_GetCheckpointsWRBonus);
	
	CreateNative("Timer_GetActiveHud", Native_GetActiveHud);
	CreateNative("Timer_SetActiveHud", Native_SetActiveHud);
	
	return APLRes_Success;
}

/***********************************************************/
/******************** NATIVE GET CP WR *********************/
/***********************************************************/
public int Native_GetCheckpointsWR(Handle plugin, int numParams)
{
	int client 	= GetNativeCell(1);
	int style 	= GetNativeCell(2);
	int level 	= GetNativeCell(3);
	SetNativeCellRef(4, F_infopanel[client][style][level][0]);
	SetNativeCellRef(5, F_infopanel[client][style][level][2]);
	
	return true;
}

/***********************************************************/
/***************** NATIVE GET CP WR BONUS ******************/
/***********************************************************/
public int Native_GetCheckpointsWRBonus(Handle plugin, int numParams)
{
	int client 	= GetNativeCell(1);
	int style 	= GetNativeCell(2);
	int bonus 	= GetNativeCell(3);
	int level 	= GetNativeCell(4);
	SetNativeCellRef(5, F_infopanelbonus[client][style][bonus][level]);
	SetNativeCellRef(6, F_infopanelbonus3[client][style][bonus][level]);
	
	return true;
}

/***********************************************************/
/******************** NATIVE ACTIVE HUD ********************/
/***********************************************************/
public int Native_GetActiveHud(Handle plugin, int numParams)
{
	int client 		= GetNativeCell(1);
	return B_active_hud[client];
}

/***********************************************************/
/******************** NATIVE ACTIVE HUD ********************/
/***********************************************************/
public int Native_SetActiveHud(Handle plugin, int numParams)
{
	int client 		= GetNativeCell(1);
	B_active_hud[client] = GetNativeCell(2);
	SetClientCookie(client, CookieTimerCPChat, (B_active_hud[client]) ? "1" : "0");	
	CPrintToChat(client, "[{GREEN}CHECKPOINTS{NORMAL}] CPS chat turn %s", (B_active_hud[client]) ? "{GREEN}On" : "{RED}Off");
}

/***********************************************************/
/*********************** PLUGIN START **********************/
/***********************************************************/
public void OnPluginStart()
{
	LoadPhysics();
	
	AutoExecConfig_SetFile("drapi_timer_checkpoint", "sourcemod/drapi");
	
	AutoExecConfig_CreateConVar("drapi_timer_checkpoint_version", PLUGIN_VERSION, "Version", CVARS);
	
	cvar_active_timer_checkpoint_dev			= AutoExecConfig_CreateConVar("drapi_active_timer_checkpoint_dev", 			"0", 					"Enable/Disable Dev Mod", 				DEFAULT_FLAGS, 		true, 0.0, 		true, 1.0);
	
	HookEventsCvars();
	
	AutoExecConfig_ExecuteFile();
	
	CookieTimerCPChat 		= RegClientCookie("CookieTimerCPChat", "", CookieAccess_Private);
	
	RegConsoleCmd("togglecps", Command_ToggleCPS, "trun off/on chat cp");
	
	RegConsoleCmd("cpr", Command_PlayerInfoCP, "playerinfo checkpoints");
	RegConsoleCmd("cprb", Command_PlayerInfoCPBonus, "playerinfo checkpoints bonus");
	
	RegConsoleCmd("b1cpr", Command_PlayerInfoCPBonusB1, "playerinfo checkpoints B1");
	RegConsoleCmd("b2cpr", Command_PlayerInfoCPBonusB2, "playerinfo checkpoints B2");
	RegConsoleCmd("b3cpr", Command_PlayerInfoCPBonusB3, "playerinfo checkpoints B3");
	RegConsoleCmd("b4cpr", Command_PlayerInfoCPBonusB4, "playerinfo checkpoints B4");
	RegConsoleCmd("b5cpr", Command_PlayerInfoCPBonusB5, "playerinfo checkpoints B5");
	
	int i = 1;
	while (i <= MaxClients)
	{
		if(IsClientInGame(i))
		{
			if(AreClientCookiesCached(i))
			{
				OnClientCookiesCached(i);
			}
		}
		i++;
	}
	
	if (g_hSQL == INVALID_HANDLE)
	{
		ConnectSQL();
	}
}

/***********************************************************/
/******************** WHEN CVAR CHANGED ********************/
/***********************************************************/
void HookEventsCvars()
{
	HookConVarChange(cvar_active_timer_checkpoint_dev, 				Event_CvarChange);
}

/***********************************************************/
/******************** WHEN CVARS CHANGE ********************/
/***********************************************************/
public void Event_CvarChange(Handle cvar, const char[] oldValue, const char[] newValue)
{
	UpdateState();
}

/***********************************************************/
/*********************** UPDATE STATE **********************/
/***********************************************************/
void UpdateState()
{
	B_active_timer_checkpoint_dev 					= GetConVarBool(cvar_active_timer_checkpoint_dev);
}

/***********************************************************/
/******************* WHEN CONFIG EXECUTED ******************/
/***********************************************************/
public void OnConfigsExecuted()
{
	//UpdateState();
}

/***********************************************************/
/**************** WHEN CLIENT PUT IN SERVER ****************/
/***********************************************************/
public void OnClientPutInServer(int client)
{
	B_active_hud_backstage[client] = true;
}

/***********************************************************/
/**************** ON CLIENT COOKIE CACHED ******************/
/***********************************************************/
public void OnClientCookiesCached(int client)
{
	char value[16];
	
	GetClientCookie(client, CookieTimerCPChat, value, sizeof(value));
	if(strlen(value) > 0) 
	{
		B_active_hud[client] 		= view_as<bool>(StringToInt(value));
	}
	else 
	{
		B_active_hud[client] 		= true;
	}
}
/***********************************************************/
/********************* WHEN MAP START **********************/
/***********************************************************/
public void OnMapStart()
{
	LoadPhysics();
	
	UpdateState();
	
	if(g_hSQL == INVALID_HANDLE)
	{
		ConnectSQL();
	}
	
	GetCurrentMap(S_mapname, 32);
	
	for(int i = 1; i < MAXPLAYERS; i++)
	{
		for(int style = 0; style < MAX_STYLE-1; style++)
		{
			for(int level = 0; level < MAX_LEVEL-1; level++)
			{	
				F_infopanel[i][style][level][0] = 0.0;
				F_infopanel[i][style][level][1] = 0.0;
				F_infopanel[i][style][level][2] = 0.0;
				S_infopanel[i][style] = "";
			}
			
			for(int bonus = 0; bonus < MAX_BONUS-1; bonus++)
			{
				for(int level = 0; level < MAX_LEVEL-1; level++)
				{
					F_infopanelbonus[i][style][bonus][level] = 0.0;
					F_infopanelbonus2[i][style][bonus][level] = 0.0;
					F_infopanelbonus3[i][style][bonus][level] = 0.0;
					S_infopanelbonus[i][style][bonus] = "";
				}
			}
		}
	}
}
/***********************************************************/
/***************** ON TIMER SQL CONNECTED ******************/
/***********************************************************/
public int OnTimerSqlConnected(Handle sql)
{
	g_hSQL = sql;
	g_hSQL = INVALID_HANDLE;
	CreateTimer(0.1, Timer_SQLReconnect, _ , TIMER_FLAG_NO_MAPCHANGE);
}

/***********************************************************/
/******************** ON TIMER SQL STOP ********************/
/***********************************************************/
public int OnTimerSqlStop()
{
	g_hSQL = INVALID_HANDLE;
	CreateTimer(0.1, Timer_SQLReconnect, _ , TIMER_FLAG_NO_MAPCHANGE);
}

/***********************************************************/
/*********************** SQL CONNECT ***********************/
/***********************************************************/
void ConnectSQL()
{
	g_hSQL = view_as<Handle>(Timer_SqlGetConnection());
	
	if(g_hSQL == INVALID_HANDLE)
	{
		CreateTimer(0.1, Timer_SQLReconnect, _ , TIMER_FLAG_NO_MAPCHANGE);
	}
}

/***********************************************************/
/****************** TIMER SQL RECONNECTED ******************/
/***********************************************************/
public Action Timer_SQLReconnect(Handle timer, any data)
{
	ConnectSQL();
	return Plugin_Stop;
}

/***********************************************************/
/******************** CMD PLAYER CHAT CP *******************/
/***********************************************************/
public Action Command_ToggleCPS(int client, int args)
{
	B_active_hud[client] 		= !B_active_hud[client];
	SetClientCookie(client, CookieTimerCPChat, (B_active_hud[client]) ? "1" : "0");	
	
	CPrintToChat(client, "[{GREEN}CHECKPOINTS{NORMAL}] CPS chat turn %s", (B_active_hud[client]) ? "{GREEN}On" : "{RED}Off");
	return Plugin_Handled;
}
/***********************************************************/
/******************** CMD PLAYER INFO CP *******************/
/***********************************************************/
public Action Command_PlayerInfoCP(int client, int args)
{
	int style = Timer_GetStyle(client);
	
	if(S_infopanel[client][style][0])
	{
		Menu menu = CreateMenu(Menu_PlayerInfo_Handler);
		
		char S_title[PLATFORM_MAX_PATH];
		
		//Ðr. A?? vs WR > Style: Normal- WR by: bro
		Format(S_title, sizeof(S_title), "%N vs WR | Style: %s | WR holder: %s", client, g_Physics[style][StyleName], S_infopanel[client][style]);
		SetMenuTitle(menu, S_title);
		
		//CP #1: 00.00.00 (+00.00.00) PB: 00.00.00
		for(int level = 0; level < MAX_LEVEL - 1; level++)
		{
			char S_PBtime[64], S_WRtime[64], S_Diff[64], S_Sentence[PLATFORM_MAX_PATH];
			
			if(F_infopanel[client][style][level][0]  > 0.0)
			{
				Timer_SecondsToTime(F_infopanel[client][style][level][0], S_WRtime, sizeof(S_WRtime), 2);
				Timer_SecondsToTime(F_infopanel[client][style][level][1], S_PBtime, sizeof(S_PBtime), 2);
				
				if(F_infopanel[client][style][level][0] > F_infopanel[client][style][level][1])
				{
					Timer_SecondsToTime(F_infopanel[client][style][level][0] - F_infopanel[client][style][level][1], S_Diff, sizeof(S_Diff), 2);
					FormatEx(S_Sentence, PLATFORM_MAX_PATH, "CP #%i: %s (-%s) PB: %s", level, S_WRtime, S_Diff, S_PBtime);
				}
				else if(F_infopanel[client][style][level][0] < F_infopanel[client][style][level][1])
				{
					Timer_SecondsToTime(F_infopanel[client][style][level][1] - F_infopanel[client][style][level][0], S_Diff, sizeof(S_Diff), 2);
					FormatEx(S_Sentence, PLATFORM_MAX_PATH, "CP #%i: %s (+%s) PB: %s", level, S_WRtime, S_Diff, S_PBtime);
				}
				else if(F_infopanel[client][style][level][0] == F_infopanel[client][style][level][1])
				{
					Timer_SecondsToTime(F_infopanel[client][style][level][0] - F_infopanel[client][style][level][1], S_Diff, sizeof(S_Diff), 2);
					FormatEx(S_Sentence, PLATFORM_MAX_PATH, "CP #%i: %s (%s) PB: %s", level, S_WRtime, S_Diff, S_PBtime);
				}
				AddMenuItem(menu, "", S_Sentence, ITEMDRAW_DISABLED);
			}
		}
		
		DisplayMenu(menu, client, MENU_TIME_FOREVER);

	}
	else
	{
		CPrintToChat(client, "[{GREEN}CHECKPOINTS{NORMAL}] No data found...");
	}
	return Plugin_Handled;
}

/***********************************************************/
/******************** CMD PLAYER BONUS  ********************/
/***********************************************************/
public Action Command_PlayerInfoCPBonusB1(int client, int args)
{
	MenuBonus(client, 0);
	return Plugin_Handled;
}

/***********************************************************/
/******************** CMD PLAYER BONUS  ********************/
/***********************************************************/
public Action Command_PlayerInfoCPBonusB2(int client, int args)
{
	MenuBonus(client, 1);
	return Plugin_Handled;
}

/***********************************************************/
/******************** CMD PLAYER BONUS  ********************/
/***********************************************************/
public Action Command_PlayerInfoCPBonusB3(int client, int args)
{
	MenuBonus(client, 2);
	return Plugin_Handled;
}

/***********************************************************/
/******************** CMD PLAYER BONUS  ********************/
/***********************************************************/
public Action Command_PlayerInfoCPBonusB4(int client, int args)
{
	MenuBonus(client, 3);
	return Plugin_Handled;
}

/***********************************************************/
/******************** CMD PLAYER BONUS  ********************/
/***********************************************************/
public Action Command_PlayerInfoCPBonusB5(int client, int args)
{
	MenuBonus(client, 4);
	return Plugin_Handled;
}

/***********************************************************/
/******************** CMD PLAYER BONUS  ********************/
/***********************************************************/
public Action Command_PlayerInfoCPBonus(int client, int args)
{
	char S_args1[256];
	GetCmdArg(1, S_args1, sizeof(S_args1));
	int bonustrack = StringToInt(S_args1);
	MenuBonus(client, bonustrack);

	return Plugin_Handled;
}

/***********************************************************/
/********************* CMD MENU BONUS  *********************/
/***********************************************************/
void MenuBonus(int client, int bonustrack)
{
	int style = Timer_GetStyle(client);
	
	if(bonustrack >= 0 && bonustrack <= 5)
	{
		if(S_infopanelbonus[client][style][bonustrack][0])
		{
			Menu menu = CreateMenu(Menu_PlayerInfo_Handler);
			
			char S_title[PLATFORM_MAX_PATH];
			Format(S_title, sizeof(S_title), "%N vs WR BONUS%i | Style: %s | WR holder: %s", client, bonustrack + 1, g_Physics[style][StyleName], S_infopanel[client][style]);
			SetMenuTitle(menu, S_title);
			
			for(int level = 0; level < MAX_LEVEL - 1; level++)
			{
				char S_PBtime[64], S_WRtime[64], S_Diff[64], S_Sentence[PLATFORM_MAX_PATH];
				
				Timer_SecondsToTime(F_infopanelbonus[client][style][bonustrack][level], S_WRtime, sizeof(S_WRtime), 2);
				Timer_SecondsToTime(F_infopanelbonus2[client][style][bonustrack][level], S_PBtime, sizeof(S_PBtime), 2);
				
				if(F_infopanelbonus[client][style][bonustrack][level] > 0.0)
				{
					if(F_infopanelbonus[client][style][bonustrack][level] > F_infopanelbonus2[client][style][bonustrack][level])
					{
						Timer_SecondsToTime(F_infopanelbonus[client][style][bonustrack][level] - F_infopanelbonus2[client][style][bonustrack][level], S_Diff, sizeof(S_Diff), 2);
						FormatEx(S_Sentence, PLATFORM_MAX_PATH, "CP #%i: %s (-%s) PB: %s", level, S_WRtime, S_Diff, S_PBtime);
					}
					else if(F_infopanelbonus[client][style][bonustrack][level] < F_infopanelbonus2[client][style][bonustrack][level])
					{
						Timer_SecondsToTime(F_infopanelbonus2[client][style][bonustrack][level] - F_infopanelbonus[client][style][bonustrack][level], S_Diff, sizeof(S_Diff), 2);
						FormatEx(S_Sentence, PLATFORM_MAX_PATH, "CP #%i: %s (+%s) PB: %s", level, S_WRtime, S_Diff, S_PBtime);
					}
					else if(F_infopanelbonus[client][style][bonustrack][level] == F_infopanelbonus2[client][style][bonustrack][level])
					{
						Timer_SecondsToTime(F_infopanelbonus[client][style][bonustrack][level] - F_infopanelbonus2[client][style][bonustrack][level], S_Diff, sizeof(S_Diff), 2);
						FormatEx(S_Sentence, PLATFORM_MAX_PATH, "CP #%i: %s (%s) PB: %s", level, S_WRtime, S_Diff, S_PBtime);
					}
					
					AddMenuItem(menu, "", S_Sentence, ITEMDRAW_DISABLED);
				}
			}
			
			DisplayMenu(menu, client, MENU_TIME_FOREVER);
		}
		else
		{
			CPrintToChat(client, "[{GREEN}CHECKPOINTS{NORMAL}] No data found...");
		}
	}
	else
	{
		CPrintToChat(client, "[{GREEN}CHECKPOINTS{NORMAL}] usage: {RED}sm_cprb <num bonus>");
	}
}

/***********************************************************/
/******************* PLAYER INFO ACTION ********************/
/***********************************************************/
public int Menu_PlayerInfo_Handler(Handle menu, MenuAction action, int client, int param2)
{
	if(action == MenuAction_End)
	{
		CloseHandle(menu);
	}
}

/***********************************************************/
/***************** ON TIMER WOLRD RECORD *******************/
/***********************************************************/
public int OnTimerWorldRecord(int client, int track, int style, float time, float lasttime, int currentrank, int newrank)
{
	char wrname[64];
	GetClientName(client, wrname, sizeof(wrname));
	
	if(track == TRACK_BONUS || track == TRACK_BONUS2 || track == TRACK_BONUS3 || track == TRACK_BONUS4 || track == TRACK_BONUS5)
	{
		for(int level = 0; level < MAX_LEVEL-1; level++)
		{
			if(F_infopanelbonus2[client][style][track][level] > 0.0)
			{	
				SetPlayerCPWR(true, client, track, style, level + 1, S_mapname, F_infopanelbonus2[client][style][track][level]);
				for(int i = 1; i < MAXPLAYERS; i++)
				{
					F_infopanelbonus[i][style][track][level] = F_infopanelbonus2[client][style][track][level];
					strcopy(S_infopanelbonus[i][style][track], PLATFORM_MAX_PATH, wrname);
				}
			}
		}	
	}
	else
	{
		for(int level = 0; level < MAX_LEVEL-1; level++)
		{
			if(F_infopanel[client][style][level][2] > 0.0)
			{
				SetPlayerCPWR(false, client, track, style, level + 1, S_mapname, F_infopanel[client][style][level][2]);
				for(int i = 1; i < MAXPLAYERS; i++)
				{
					F_infopanel[i][style][level][0] = F_infopanel[client][style][level][2];
					strcopy(S_infopanel[i][style], PLATFORM_MAX_PATH, wrname);
				}
			}
		}	
	}
}

/***********************************************************/
/****************** ON CLIENT TOUCH LEVEL ******************/
/***********************************************************/
public int OnClientStartTouchLevel(int client, int level, int lastlevel)
{
	if(level == lastlevel + 1 && Timer_GetStatus(client))
	{
		B_active_hud_backstage[client] = true;
		bool enabled = false;
		float time;
		int jumps, fpsmax;
		
		Timer_GetClientTimer(client, enabled, time, jumps, fpsmax);
		SetPlayerCP(false, client, level, S_mapname, time);
	}
	else
	{
		B_active_hud_backstage[client] = false;
	}
	
	if(B_active_timer_checkpoint_dev)
	{
		PrintToChat(client, "OnClientStartTouchLevel: %i, %i", level, lastlevel);
	}
}

/***********************************************************/
/*************** ON CLIENT TOUCH BONUS LEVEL ***************/
/***********************************************************/
public int OnClientStartTouchBonusLevel(int client, int level, int lastlevel)
{
	if(level == lastlevel + 1 && Timer_GetStatus(client))
	{
		B_active_hud_backstage[client] = true;
		bool enabled = false;
		float time;
		int jumps, fpsmax;
		
		Timer_GetClientTimer(client, enabled, time, jumps, fpsmax);
		SetPlayerCP(true, client, level, S_mapname, time);
	}
	else
	{
		B_active_hud_backstage[client] = false;
	}
	
	if(B_active_timer_checkpoint_dev)
	{
		PrintToChat(client, "OnClientStartTouchBonusLevel: %i, %i", level, lastlevel);
	}
}


/***********************************************************/
/*************** SET PLAYER CHECKPOINTS WR *****************/
/***********************************************************/
public int SetPlayerCPWR(bool bonus, int client, int track, int style, int level, char[] map, float time)
{
	char steamid[32], name[64], levelname[60], error[255];
	
	GetClientName(client, name, sizeof(name));
	GetClientAuthId(client, AuthId_Steam2, steamid, sizeof(steamid), true);
	
	if(bonus)
	{
		Format(levelname, 60, "Bonus %i", level);
	}
	else
	{
		Timer_GetLevelName(level, levelname, sizeof(levelname));
	}
	
	//SELECT PB TIME
	Handle query = SQL_PrepareQuery(g_hSQL, sql_SelectPlayerCPWR, error, 255);
	
	if(query != INVALID_HANDLE)
	{
		SQL_BindParamString(query, 	0, map, 		false);
		SQL_BindParamInt(query, 	1, level, 		false);
		SQL_BindParamInt(query, 	2, track, 		false);
		SQL_BindParamInt(query, 	3, style, 		false);
		
		if (!SQL_Execute(query))
		{
			return 0;
		}
		
		if(SQL_GetRowCount(query))
		{
			//UPDATE BEST PB TIME
			if(!IsFakeClient(client))
			{
				Handle updateQuery = SQL_PrepareQuery(g_hSQL, sql_updatePlayerCPWR, error, 255);
				if(updateQuery != INVALID_HANDLE)
				{
					SQL_BindParamFloat(updateQuery, 	0, time);
					SQL_BindParamString(updateQuery, 	1, name, 		false);
					SQL_BindParamString(updateQuery, 	2, steamid, 	false);
					SQL_BindParamString(updateQuery, 	3, map, 		false);
					SQL_BindParamInt(updateQuery, 		4, level, 		false);
					SQL_BindParamInt(updateQuery, 		5, track, 		false);
					SQL_BindParamInt(updateQuery, 		6, style, 		false);
					
					if (!SQL_Execute(updateQuery))
					{
						return 0;
					}
					
					CloseHandle(updateQuery);
					
					if(B_active_timer_checkpoint_dev)
					{
						PrintToChatAll("UPDATE WR: %s, time: %f", name, time);
					}
				}
			}
		}
		else
		{
			//INSERT PB TIME
			if(!IsFakeClient(client))
			{
				Handle insertQuery = SQL_PrepareQuery(g_hSQL, sql_insertPlayerCPWR, error, 255);
				
				if(insertQuery != INVALID_HANDLE)
				{
					SQL_BindParamString(insertQuery, 	0, steamid, 	false);
					SQL_BindParamString(insertQuery, 	1, map, 		false);
					SQL_BindParamInt(insertQuery, 		2, level, 		false);
					SQL_BindParamString(insertQuery, 	3, levelname, 	false);
					SQL_BindParamFloat(insertQuery, 	4, time);
					SQL_BindParamString(insertQuery, 	5, name, 		false);
					SQL_BindParamInt(insertQuery, 		6, track, 		false);
					SQL_BindParamInt(insertQuery, 		7, style, 		false);
					
					if(!SQL_Execute(insertQuery))
					{
						return 0;
					}
					
					CloseHandle(insertQuery);
					
					if(B_active_timer_checkpoint_dev)
					{
						PrintToChatAll("INSERT WR: %s, time: %f", name, time);
					}
				}
			}
		}
		CloseHandle(query);
	}
	
	return 0;
}

/***********************************************************/
/**************** COMPARE WR CP TO YOUR CP *****************/
/***********************************************************/
public float CompareWRCPtoPBCP(bool bonus, int client, int level, char[] map)
{
	char steamid[32], name[64], error[255], wrname[64];
	
	GetClientName(client, name, sizeof(name));
	GetClientAuthId(client, AuthId_Steam2, steamid, sizeof(steamid), true);
	
	int track = Timer_GetTrack(client);
	int style = Timer_GetStyle(client);
	
	//SELECT WR RUN MAP CP TIME
	Handle queryWR = SQL_PrepareQuery(g_hSQL, sql_selectWRMap, error, 255);
	
	if(queryWR != INVALID_HANDLE)
	{
		SQL_BindParamInt(queryWR, 		0, level, 		false);
		SQL_BindParamString(queryWR, 	1, map, 		false);
		SQL_BindParamInt(queryWR, 		2, track, 		false);
		SQL_BindParamInt(queryWR, 		3, style, 		false);

		if (!SQL_Execute(queryWR))
		{
			return 0.0;
		}
		
		if(SQL_GetRowCount(queryWR))
		{
			while(SQL_FetchRow(queryWR))
			{
				SQL_FetchString(queryWR, 1, wrname, 64); 
				float WRtime = SQL_FetchFloat(queryWR, 5);
				int WRstyle = SQL_FetchInt(queryWR, 4);
				
				if(bonus)
				{
					int bonusid = SQL_FetchInt(queryWR, 3);
					strcopy(S_infopanelbonus[client][WRstyle][bonusid-1], PLATFORM_MAX_PATH, wrname);
				}
				else
				{
					strcopy(S_infopanel[client][WRstyle], PLATFORM_MAX_PATH, wrname);
				}
				return WRtime;
			}
		}
			
	}
	return 0.0;
}

/***********************************************************/
/***************** SET PLAYER CHECKPOINTS ******************/
/***********************************************************/
public int SetPlayerCP(bool bonus, int client, int level, char[] map, float time)
{
	char steamid[32], name[64], levelname[60], error[255];
	
	GetClientName(client, name, sizeof(name));
	GetClientAuthId(client, AuthId_Steam2, steamid, sizeof(steamid), true);
	
	if(bonus)
	{
		Format(levelname, 60, "Bonus %i", level);
	}
	else
	{
		Timer_GetLevelName(level, levelname, sizeof(levelname));
	}
	int track = Timer_GetTrack(client);
	int style = Timer_GetStyle(client);
	
	//SELECT PB TIME
	Handle query = SQL_PrepareQuery(g_hSQL, sql_SelectPlayerCP, error, 255);
	
	if(query != INVALID_HANDLE)
	{
		SQL_BindParamString(query, 	0, steamid, 	false);
		SQL_BindParamInt(query, 	1, level, 		false);
		SQL_BindParamString(query, 	2, map, 		false);
		SQL_BindParamInt(query, 	3, track, 		false);
		SQL_BindParamInt(query, 	4, style, 		false);
		
		if (!SQL_Execute(query))
		{
			return 0;
		}
		
		if(SQL_GetRowCount(query))
		{
			while(SQL_FetchRow(query))
			{
				float lastime = SQL_FetchFloat(query, 5);
				
				char S_compareWR[PLATFORM_MAX_PATH], S_comparePB[PLATFORM_MAX_PATH];
				float WRtime = CompareWRCPtoPBCP(bonus, client, level, map);
				
				int clevel;
				if(bonus)
				{
					int bonusid = Timer_GetTrack(client);
					if(bonusid == TRACK_BONUS)
					{
						clevel = level - 1001;
					}
					else if(bonusid == TRACK_BONUS2)
					{
						clevel = level - 2001;
					}
					else if(bonusid == TRACK_BONUS3)
					{
						clevel = level - 3001;
					}
					else if(bonusid == TRACK_BONUS4)
					{
						clevel = level - 4001;
					}
					else if(bonusid == TRACK_BONUS5)
					{
						clevel = level - 5001;
					}
					F_infopanelbonus[client][style][bonusid-1][clevel] = WRtime;
					F_infopanelbonus2[client][style][bonusid-1][clevel] = lastime;
					F_infopanelbonus3[client][style][bonusid-1][clevel] = time;
				}
				else
				{
					clevel = level - 1;
					F_infopanel[client][style][clevel][0] = WRtime;
					F_infopanel[client][style][clevel][1] = lastime;
					F_infopanel[client][style][clevel][2] = time;
				}
				
				char S_compareWRStoT[32], S_comparePBStoT[32];
				
				if(WRtime > time)
				{
					Timer_SecondsToTime(WRtime - time, S_compareWRStoT, sizeof(S_compareWRStoT), 2);
					FormatEx(S_compareWR, PLATFORM_MAX_PATH, "{GREEN}-%s{NORMAL}", S_compareWRStoT);
				}
				else if(WRtime < time)
				{
					Timer_SecondsToTime(time - WRtime, S_compareWRStoT, sizeof(S_compareWRStoT), 2);
					FormatEx(S_compareWR, PLATFORM_MAX_PATH, "{RED}+%s{NORMAL}", S_compareWRStoT);
				}
				else if(WRtime == time)
				{
					Timer_SecondsToTime(time - WRtime, S_compareWRStoT, sizeof(S_compareWRStoT), 2);
					FormatEx(S_compareWR, PLATFORM_MAX_PATH, "{YELLOW}%s{NORMAL}", S_compareWRStoT);
				}
				
				if(lastime > time)
				{
					Timer_SecondsToTime(lastime - time, S_comparePBStoT, sizeof(S_comparePBStoT), 2);
					FormatEx(S_comparePB, PLATFORM_MAX_PATH, "{GREEN}-%s{NORMAL}", S_comparePBStoT);
				}
				else if(lastime < time)
				{
					Timer_SecondsToTime(time - lastime, S_comparePBStoT, sizeof(S_comparePBStoT), 2);
					FormatEx(S_comparePB, PLATFORM_MAX_PATH, "{RED}+%s{NORMAL}", S_comparePBStoT);
				}
				else if(lastime == time)
				{
					Timer_SecondsToTime(time - lastime, S_comparePBStoT, sizeof(S_comparePBStoT), 2);
					FormatEx(S_comparePB, PLATFORM_MAX_PATH, "{YELLOW}%s{NORMAL}", S_comparePBStoT);
				}
				
				char S_currenttime[PLATFORM_MAX_PATH];
				Timer_SecondsToTime(time, S_currenttime, sizeof(S_currenttime), 2);
				
				if(B_active_hud_backstage[client] && B_active_hud[client])
				{
					if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(41)))
					{
						if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
						{
							CPrintToChat(client, "[{GREEN}CP %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | WR: %s | PB: %s", clevel, S_currenttime, S_compareWR, S_comparePB);
						}
						else
						{
							CPrintToChat(client, "[{GREEN}CP %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | PB: %s", clevel, S_currenttime, S_comparePB);
						}
					}
					else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(6)))
					{
						if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
						{
							CPrintToChat(client, "[{GREEN}STAGE %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | WR: %s | PB: %s", clevel, S_currenttime, S_compareWR, S_comparePB);
						}
						else
						{
							CPrintToChat(client, "[{GREEN}STAGE %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | PB: %s", clevel, S_currenttime, S_comparePB);
						}
					}
					else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(42)))
					{
						if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
						{
							CPrintToChat(client, "[{GREEN}BCP %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | WR: %s | PB: %s", clevel, S_currenttime, S_compareWR, S_comparePB);
						}
						else
						{
							CPrintToChat(client, "[{GREEN}BCP %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | PB: %s", clevel, S_currenttime, S_comparePB);
						}
					}
				}
				
				for(int i = 1; i <= MaxClients; i++)
				{
					if(IsClientInGame(i) && B_active_hud_backstage[client] && B_active_hud[client] && (!IsPlayerAlive(i) || IsClientObserver(i)))
					{
						int iObserverMode = GetEntProp(i, Prop_Send, "m_iObserverMode");
						if(iObserverMode == SPECMODE_FIRSTPERSON || iObserverMode == SPECMODE_3RDPERSON)
						{
							int clienttoshow = GetEntPropEnt(i, Prop_Send, "m_hObserverTarget");
							if(clienttoshow > 0 && clienttoshow < (MaxClients + 1) && clienttoshow == client)
							{
								if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(41)))
								{
									if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
									{
										CPrintToChat(i, "[{GREEN}CP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | WR: %s | PB: %s", clevel, name, S_currenttime, S_compareWR, S_comparePB);
									}
									else
									{
										CPrintToChat(i, "[{GREEN}CP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | PB: %s", clevel, name, S_currenttime, S_comparePB);
									}
								}
								else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(6)))
								{
									if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
									{
										CPrintToChat(i, "[{GREEN}STAGE %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | WR: %s | PB: %s", clevel, name, S_currenttime, S_compareWR, S_comparePB);		
									}
									else
									{
										CPrintToChat(i, "[{GREEN}STAGE %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | PB: %s", clevel, name, S_currenttime, S_comparePB);		
									}
								}
								else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(42)))
								{
									if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
									{
										CPrintToChat(i, "[{GREEN}BCP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | WR: %s | PB: %s", level - 1001, name, S_currenttime, S_compareWR, S_comparePB);	
									}
									else
									{
										CPrintToChat(i, "[{GREEN}BCP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | PB: %s", level - 1001, name, S_currenttime, S_comparePB);	
									}
								}
							}
						}
					}
				}
				
				if(time < lastime)
				{
					if(bonus)
					{
						int bonusid = Timer_GetTrack(client);
						F_infopanelbonus2[client][style][bonusid-1][clevel] = time;
					}
					else
					{
						F_infopanel[client][style][clevel][1] = time;
					}
				}
				else
				{
					return 0;		
				}
			}
			
			//UPDATE BEST PB TIME
			if(!IsFakeClient(client))
			{
				Handle updateQuery = SQL_PrepareQuery(g_hSQL, sql_updatePlayerCP, error, 255);
				if(updateQuery != INVALID_HANDLE)
				{
					SQL_BindParamFloat(updateQuery, 	0, time);
					SQL_BindParamString(updateQuery, 	1, name, 		false);
					SQL_BindParamString(updateQuery, 	2, steamid, 	false);
					SQL_BindParamString(updateQuery, 	3, map, 		false);
					SQL_BindParamInt(updateQuery, 		4, level, 		false);
					SQL_BindParamInt(updateQuery, 		5, track, 		false);
					SQL_BindParamInt(updateQuery, 		6, style, 		false);
					
					if (!SQL_Execute(updateQuery))
					{
						return 0;
					}
					
					CloseHandle(updateQuery);
					
					if(B_active_timer_checkpoint_dev)
					{
						PrintToChatAll("UPDATE: %s, time: %f", name, time);
					}
				}
			}
		}
		else
		{
			char S_compareWR[PLATFORM_MAX_PATH];
			float WRtime = CompareWRCPtoPBCP(bonus, client, level, map);
			
			int clevel;
			if(bonus)
			{
				int bonusid = Timer_GetTrack(client);
				if(bonusid == TRACK_BONUS)
				{
					clevel = level - 1001;
				}
				else if(bonusid == TRACK_BONUS2)
				{
					clevel = level - 2001;
				}
				else if(bonusid == TRACK_BONUS3)
				{
					clevel = level - 3001;
				}
				else if(bonusid == TRACK_BONUS4)
				{
					clevel = level - 4001;
				}
				else if(bonusid == TRACK_BONUS5)
				{
					clevel = level - 5001;
				}
				F_infopanelbonus[client][style][bonusid-1][clevel] = WRtime;
				F_infopanelbonus2[client][style][bonusid-1][clevel] = time;
				F_infopanelbonus3[client][style][bonusid-1][clevel] = time;
			}
			else
			{
				clevel = level - 1;
				F_infopanel[client][style][clevel][0] = WRtime;
				F_infopanel[client][style][clevel][1] = time;
				F_infopanel[client][style][clevel][2] = time;
			}
				
			char S_compareWRStoT[32];
			
			if(BotMimic_IsPlayerMimicing(client))
			{
				time = GetGameTime() - F_Timer[client];
			}
			
			if(WRtime > time)
			{
				Timer_SecondsToTime(WRtime - time, S_compareWRStoT, sizeof(S_compareWRStoT), 2);
				FormatEx(S_compareWR, PLATFORM_MAX_PATH, "{GREEN}-%s{NORMAL}", S_compareWRStoT);
			}
			else if(WRtime < time)
			{
				Timer_SecondsToTime(time - WRtime, S_compareWRStoT, sizeof(S_compareWRStoT), 2);
				FormatEx(S_compareWR, PLATFORM_MAX_PATH, "{RED}+%s{NORMAL}", S_compareWRStoT);
			}
			else if(WRtime == time)
			{
				Timer_SecondsToTime(time - WRtime, S_compareWRStoT, sizeof(S_compareWRStoT), 2);
				FormatEx(S_compareWR, PLATFORM_MAX_PATH, "{YELLOW}%s{NORMAL}", S_compareWRStoT);
			}

			char S_currenttime[PLATFORM_MAX_PATH];
			Timer_SecondsToTime(time, S_currenttime, sizeof(S_currenttime), 2);
			
			if(B_active_hud_backstage[client] && B_active_hud[client])
			{
				if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(41)))
				{
					if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
					{
						CPrintToChat(client, "[{GREEN}CP %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | WR: %s", clevel, S_currenttime, S_compareWR);
					}
					else
					{
						CPrintToChat(client, "[{GREEN}CP %i{NORMAL}] Time: {YELLOW}%s{NORMAL}", clevel, S_currenttime);
					}
				}
				else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(6)))
				{
					if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
					{
						CPrintToChat(client, "[{GREEN}STAGE %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | WR: %s", clevel, S_currenttime, S_compareWR);
					}
					else
					{
						CPrintToChat(client, "[{GREEN}STAGE %i{NORMAL}] Time: {YELLOW}%s{NORMAL}", clevel, S_currenttime);
					}
				}
				else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(42)))
				{
					if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
					{
						CPrintToChat(client, "[{GREEN}BCP %i{NORMAL}] Time: {YELLOW}%s{NORMAL} | WR: %s", clevel, S_currenttime, S_compareWR);
					}
					else
					{
						CPrintToChat(client, "[{GREEN}BCP %i{NORMAL}] Time: {YELLOW}%s{NORMAL}", clevel, S_currenttime);
					}
				}
			}
			
			for(int i = 1; i <= MaxClients; i++)
			{
				if(IsClientInGame(i) && B_active_hud_backstage[client] && B_active_hud[client] && (!IsPlayerAlive(i) || IsClientObserver(i)))
				{
					int iObserverMode = GetEntProp(i, Prop_Send, "m_iObserverMode");
					if(iObserverMode == SPECMODE_FIRSTPERSON || iObserverMode == SPECMODE_3RDPERSON)
					{
						int clienttoshow = GetEntPropEnt(i, Prop_Send, "m_hObserverTarget");
						if(clienttoshow > 0 && clienttoshow < (MaxClients + 1) && clienttoshow == client)
						{
							if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(41)))
							{
								if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
								{
									CPrintToChat(i, "[{GREEN}CP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | WR: %s", clevel, name, S_currenttime, S_compareWR);
								}
								else
								{
									CPrintToChat(i, "[{GREEN}CP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL}", clevel, name, S_currenttime);
								}
							}
							else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(6)))
							{
								if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
								{
									CPrintToChat(i, "[{GREEN}STAGE %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | WR: %s", clevel, name, S_currenttime, S_compareWR);		
								}
								else
								{
									CPrintToChat(i, "[{GREEN}STAGE %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL}", clevel, name, S_currenttime);	
								}
							}
							else if(Timer_IsPlayerTouchingZoneType(client, view_as<MapZoneType>(42)))
							{
								if(!BotMimic_IsPlayerMimicing(client) && WRtime > 0.0)
								{
									CPrintToChat(i, "[{GREEN}BCP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL} | WR: %s", clevel, name, S_currenttime, S_compareWR);
								}
								else
								{
									CPrintToChat(i, "[{GREEN}BCP %i{NORMAL}] {BLUE}%s{NORMAL} Time: {YELLOW}%s{NORMAL}", clevel, name, S_currenttime);
								}
							}
						}
					}
				}
			}
			
			//INSERT PB TIME
			if(!IsFakeClient(client))
			{
				Handle insertQuery = SQL_PrepareQuery(g_hSQL, sql_insertPlayerCP, error, 255);
				
				if(insertQuery != INVALID_HANDLE)
				{
					SQL_BindParamString(insertQuery, 	0, steamid, 	false);
					SQL_BindParamString(insertQuery, 	1, map, 		false);
					SQL_BindParamInt(insertQuery, 		2, level, 		false);
					SQL_BindParamString(insertQuery, 	3, levelname, 	false);
					SQL_BindParamFloat(insertQuery, 	4, time);
					SQL_BindParamString(insertQuery, 	5, name, 		false);
					SQL_BindParamInt(insertQuery, 		6, track, 		false);
					SQL_BindParamInt(insertQuery, 		7, style, 		false);
					
					if(!SQL_Execute(insertQuery))
					{
						return 0;
					}
					
					CloseHandle(insertQuery);
					
					if(B_active_timer_checkpoint_dev)
					{
						PrintToChatAll("INSERT: %s, time: %f", name, time);
					}
				}
			}
		}
		CloseHandle(query);
	}
	
	return 0;
}

/***********************************************************/
/********************** BOT START MIMIC ********************/
/***********************************************************/
public Action BotMimic_OnPlayerStartsMimicing(int client, char[] name, char[] category, char[] path)
{
	F_Timer[client] = GetGameTime();
}
/***********************************************************/
/********************** BOT LOOP MIMIC *********************/
/***********************************************************/
public int BotMimic_OnPlayerMimicLoops(int client)
{
	F_Timer[client] = GetGameTime();
}